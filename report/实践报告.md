# 编译原理课程实践报告：Naive Compiler

数学科学学院 原梓轩 2200010825

## 一、编译器概述

### 1.1 基本功能

本编译器基于 Rust 语言编写，基本具备如下功能：

1. 将SysY语言（一种 C 语言子集）进行语法分析，生成抽象语法树。
2. 将抽象语法树转换为 Koopa IR （一种简化版本的 LLVM IR）。
3. 将 Koopa IR 转换为 RISC-V 汇编代码。

### 1.2 主要特点

本编译器的主要特点是**AA**、**BB**、**CC**。AA是……BB是……CC是……（各特点不要超过一句话）

## 二、编译器设计

### 2.1 主要模块组成

编译器由 3 个主要模块组成：

- 词法分析和语法分析：基于 `lalrpop` 第三方库，通过便捷的 BNF 定义自动将文件解析成抽象语法树。
- 中间代码生成（前端）：递归读取抽象语法树的内容，并生成 Koopa IR，并完成一些简单的优化。
- 目标代码生成（后端）：利用前端生成的中间代码，将其翻译成汇编代码，并做好栈帧分配和寄存器分配。

### 2.2 主要数据结构

#### 词法分析和语法分析

通过正则表达式，`lalrpop` 可以为我们自动辨别 `Identifier`, `i32` 以及注释等等词法分析的有关内容。

```rust
Ident: String = r"[_a-zA-Z][_a-zA-Z0-9]*" => <>.to_string();
```

如果将一个 SysY 程序视作一棵树，那么一个 `CompUnit` 的实例就是这棵树的根，根据这一情况设计了一棵树状数据结构，例如如下的定义表明了整个程序由若干函数和变量声明组成：

```rust
pub struct CompUnit {
    pub comp_items: Vec<CompItem>,
}

pub enum CompItem {
    FuncDef(FuncDef),
    Decl(Decl),
}
```

`lalrpop` 为我们提供了方便的语法分析系统。它可以通过自动在 `target` 中生成一批代码，按照类似于 `match` 的匹配机制，让我们在读取源文件时就可以用 Rust 代码完成数据结构匹配和关联。

```rust
CompItem: CompItem = {
    <Decl> => CompItem::Decl(<>),
    <FuncDef> => CompItem::FuncDef(<>)
}
```

#### 中间代码生成

在前端，我定义了一个 `GenerateIr` 的 Trait，其中的 `generate_on` 方法可以将抽象语法树转换为 Koopa IR。

### 2.3 主要设计考虑及算法选择

#### 2.3.1 符号表的设计考虑

谈谈如何处理符号表，特别是变量作用域的处理。不超过200字。

#### 2.3.2 寄存器分配策略

谈谈如何完成寄存器分配的，没分配（扔栈上也给个说法）也谈谈。不超过200字。

#### 2.3.3 采用的优化策略

谈谈做了哪些优化，不超过200字，没有的话就不用写。

#### 2.3.4 其它补充设计考虑

谈谈做了哪些设计上的考虑，不超过200字，没有的话就不用写。

## 三、编译器实现

### 3.1 各阶段编码细节

介绍各阶段实现的时候自己认为有价值的信息，本部分内容**不做特别要求和限制**。可按如下所示的各阶段组织。

#### Lv1. main函数和Lv2. 初试目标代码生成

```
这部分虽然简单，但也可以讲两句。
```

#### Lv3. 表达式

```
有感触就说点啥，例如优先级。
```

#### Lv4. 常量和变量

```
总会有点想说的，因为多了变量。
```

#### Lv5. 语句块和作用域

```
作用域嵌套就没有可以分享的地方么？
```

#### Lv6. if语句

```
关于二义性问题是不是能在这里讨论一下。
```

#### Lv7. while语句

```
循环嵌套和控制流，总会有点想说的吧？
```

#### Lv8. 函数和全局变量

```
传参和返回值的处理，有想分享的地方么？
```

#### Lv9. 数组

```
数组参数？多维数组？不过……如果没做到这个阶段就不用写了。
```

### 3.2 工具软件介绍（若未使用特殊软件或库，则本部分可略过）

1. `例如flex/bison`：（100字以内，说明利用这个工具/模块/库做了什么）
2. `例如libkoopa`：（同上）
3. `其它软件或库`：（同上）

### 3.3 测试情况说明（如果进行过额外的测试，可增加此部分内容）

简述如何构造用例，测出过哪些不一样的错误，怎么发现和解决的。为课程提供优质测试用例会获得bonus。

## 四、实习总结

请至少谈1点，多谈谈更好。有机会获得奶茶或咖啡一杯。可以考虑按下面的几点讨论。

### 4.1 收获和体会

### 4.2 学习过程中的难点，以及对实习过程和内容的建议

### 4.3 对老师讲解内容与方式的建议
